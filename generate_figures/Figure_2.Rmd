---
title: "Figure_2"
output: html_document
date: "2025-05-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Necessary packages

```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(Deriv)
library(MASS)
library(tidyr)
library(lubridate)
library(scales)
library(gridExtra)
library(patchwork)
library(reshape2)
library(ggpubr)
```

# Part 1: Bootstrapping to get confidence intervals around the contact data and c_ij's

```{r}
# Set the path to your folder
folder_path <- "/Users/df23614/Desktop/vaccine_model/github_codes/data/UK CoMix bootstrap data"

# Get the list of all CSV files in the folder
file_list <- list.files(path = folder_path, pattern = "UK_CoMix_bootstrap_.*\\.csv$", full.names = TRUE)

# Read all files into a list of data frames
sample_data <- lapply(file_list, read.csv)
```

Read vaccine data do the preparation for that one

```{r}
vacc <- read.csv("/Users/df23614/Desktop/vaccine_model/github_codes/data/Vac_perc.csv")

# Data pre-processing
## Remove first three rows (general info about the data)
vacc <- vacc[-(1:6), ]
## Remove the last row (no data)
vacc <- vacc[1:(nrow(vacc) - 1), ]

## Rename the columns
names(vacc) <- c("date", "perc_first_dose", "perc_second_dose", "perc_third_dose")

vacc <- vacc %>%
  mutate(
    date = dmy(date))

vacc$perc_first_dose <- as.numeric(vacc$perc_first_dose)
vacc$perc_second_dose <- as.numeric(vacc$perc_second_dose)
vacc$perc_third_dose <- as.numeric(vacc$perc_third_dose)

```

```{r}
# Create a full sequence of daily dates
full_dates <- tibble(date = seq(min(vacc$date), max(vacc$date), by = "day"))

vacc_daily <- full_dates %>%
  left_join(vacc, by = "date") %>%
  mutate(
    perc_first_dose = spline(vacc$date, vacc$perc_first_dose, xout = date)$y,
    perc_second_dose = spline(vacc$date, vacc$perc_second_dose, xout = date)$y,
    perc_third_dose = spline(vacc$date, vacc$perc_third_dose, xout = date)$y
  )
```

Data preparation. For each data adjust the dates by taking midpoint

```{r warning=FALSE}
date_prepared_data <- list()

for (dat in 1:length(sample_data)) {
  
  sample_dat <- sample_data[[dat]]
  
  # convert into date format
  sample_dat <- sample_dat %>%
    mutate(start.date = ymd(start.date),
           end.date = ymd(end.date)
  )
  # convert into long format to take midpoints
  sample_long <- reshape2::melt(sample_dat, id.vars = "start.day.as.a.number",
                   measure.vars = c("start.date", "end.date"),
                   variable.name = "date")
  
  # Get the midpoints
  sample_long <- sample_long %>%
    group_by(start.day.as.a.number) %>%
    mutate(mid_date = mean(value))
  
  sample_dat$date <- unique(sample_long$mid_date)

  # Remove start and end dates
  sample_dat <- sample_dat[, -c(1,2,3)]
  
  date_prepared_data[[dat]] <- sample_dat
}
```

Now for each data calculate the number of contacts

```{r}
for (dat in 1:length(date_prepared_data)) {
  
  sample_dat <- date_prepared_data[[dat]]
  
  for (i in 1:length(sample_dat$date)) {
    if (i < 4) {
      sample_dat$mean.0.17.to.0.17[i] <- 0
      sample_dat$mean.0.17.to.18.45[i] <- 0
      sample_dat$mean.0.17.to.45.64[i] <- 0
      sample_dat$mean.0.17.to.65.120[i] <- 0
    
      sample_dat$mean.18.45.to.0.17[i] <- sample_dat$X18.45.to.0.17[i]/sample_dat$N.18.45[i]
      sample_dat$mean.18.45.to.18.45[i] <- sample_dat$X18.45.to.18.45[i]/sample_dat$N.18.45[i]
      sample_dat$mean.18.45.to.45.64[i] <- sample_dat$X18.45.to.45.64[i]/sample_dat$N.18.45[i]
      sample_dat$mean.18.45.to.65.120[i] <- sample_dat$X18.45.to.65.120[i]/sample_dat$N.18.45[i]
    
      sample_dat$mean.45.64.to.0.17[i] <- sample_dat$X45.64.to.0.17[i]/sample_dat$N.45.64[i]
      sample_dat$mean.45.64.to.18.45[i] <- sample_dat$X45.64.to.18.45[i]/sample_dat$N.45.64[i]
      sample_dat$mean.45.64.to.45.64[i] <- sample_dat$X45.64.to.45.64[i]/sample_dat$N.45.64[i]
      sample_dat$mean.45.64.to.65.120[i] <- sample_dat$X45.64.to.65.120[i]/sample_dat$N.45.64[i]
    
      sample_dat$mean.65.120.to.0.17[i] <- sample_dat$X65.120.to.0.17[i]/sample_dat$N.65.120[i]
      sample_dat$mean.65.120.to.18.45[i] <- sample_dat$X65.120.to.18.45[i]/sample_dat$N.65.120[i]
      sample_dat$mean.65.120.to.45.64[i] <- sample_dat$X65.120.to.45.64[i]/sample_dat$N.65.120[i]
      sample_dat$mean.65.120.to.65.120[i] <- sample_dat$X65.120.to.65.120[i]/sample_dat$N.65.120[i]
    
    } else {
      sample_dat$mean.0.17.to.0.17[i] <- sample_dat$X0.17.to.0.17[i]/sample_dat$N.0.17[i]
      sample_dat$mean.0.17.to.18.45[i] <- sample_dat$X0.17.to.18.45[i]/sample_dat$N.0.17[i]
      sample_dat$mean.0.17.to.45.64[i] <- sample_dat$X0.17.to.45.64[i]/sample_dat$N.0.17[i]
      sample_dat$mean.0.17.to.65.120[i] <- sample_dat$X0.17.to.65.120[i]/sample_dat$N.0.17[i]
    
      sample_dat$mean.18.45.to.0.17[i] <- sample_dat$X18.45.to.0.17[i]/sample_dat$N.18.45[i]
      sample_dat$mean.18.45.to.18.45[i] <- sample_dat$X18.45.to.18.45[i]/sample_dat$N.18.45[i]
      sample_dat$mean.18.45.to.45.64[i] <- sample_dat$X18.45.to.45.64[i]/sample_dat$N.18.45[i]
      sample_dat$mean.18.45.to.65.120[i] <- sample_dat$X18.45.to.65.120[i]/sample_dat$N.18.45[i]
    
      sample_dat$mean.45.64.to.0.17[i] <- sample_dat$X45.64.to.0.17[i]/sample_dat$N.45.64[i]
      sample_dat$mean.45.64.to.18.45[i] <- sample_dat$X45.64.to.18.45[i]/sample_dat$N.45.64[i]
      sample_dat$mean.45.64.to.45.64[i] <- sample_dat$X45.64.to.45.64[i]/sample_dat$N.45.64[i]
      sample_dat$mean.45.64.to.65.120[i] <- sample_dat$X45.64.to.65.120[i]/sample_dat$N.45.64[i]
    
      sample_dat$mean.65.120.to.0.17[i] <- sample_dat$X65.120.to.0.17[i]/sample_dat$N.65.120[i]
      sample_dat$mean.65.120.to.18.45[i] <- sample_dat$X65.120.to.18.45[i]/sample_dat$N.65.120[i]
      sample_dat$mean.65.120.to.45.64[i] <- sample_dat$X65.120.to.45.64[i]/sample_dat$N.65.120[i]
      sample_dat$mean.65.120.to.65.120[i] <- sample_dat$X65.120.to.65.120[i]/sample_dat$N.65.120[i]
    
    }
  }

  # Calculate the total number of contacts for each age group
  for (i in 1:length(sample_dat$date)) {
    sample_dat$contact.0.17[i] <- sample_dat$mean.0.17.to.0.17[i] + sample_dat$mean.0.17.to.18.45[i] + sample_dat$mean.0.17.to.45.64[i] + sample_dat$mean.0.17.to.65.120[i]
  
    sample_dat$contact.18.45[i] <- sample_dat$mean.18.45.to.0.17[i] + sample_dat$mean.18.45.to.18.45[i] + sample_dat$mean.18.45.to.45.64[i] + sample_dat$mean.18.45.to.65.120[i]
  
    sample_dat$contact.45.64[i] <- sample_dat$mean.45.64.to.0.17[i] + sample_dat$mean.45.64.to.18.45[i] + sample_dat$mean.45.64.to.45.64[i] + sample_dat$mean.45.64.to.65.120[i]
  
    sample_dat$contact.65.120[i] <- sample_dat$mean.65.120.to.0.17[i] + sample_dat$mean.65.120.to.18.45[i] + sample_dat$mean.65.120.to.45.64[i] + sample_dat$mean.65.120.to.65.120[i]
  
  }

  sample_dat$"0-17" <- sample_dat$contact.0.17 
  sample_dat$"18-45" <- sample_dat$contact.18.45 
  sample_dat$"45-64" <- sample_dat$contact.45.64 
  sample_dat$"65-120" <- sample_dat$contact.65.120 
  
  for (i in 1:length(sample_dat$date)) {
    
    sample_dat$contact[i] <- (sample_dat$contact.0.17[i]*sample_dat$N.0.17[i] + sample_dat$contact.18.45[i]*sample_dat$N.18.45[i] + sample_dat$contact.45.64[i]*sample_dat$N.45.64[i] + sample_dat$contact.65.120[i]*sample_dat$N.65.120[i])/(sample_dat$N.0.17[i] +sample_dat$N.18.45[i] +sample_dat$N.45.64[i] +sample_dat$N.65.120[i])
    
  }
  
  
  
  
  date_prepared_data[[dat]] <- sample_dat
}
```

For each data combine vaccine data with bootstarp data

```{r}
combined_data <- list()

for (dat in 1:length(date_prepared_data)) {
  
  sample_dat <- date_prepared_data[[dat]]
  
  vacc_comix <- merge(vacc_daily, sample_dat, by = "date")

  # extract columns date, perc_first_dose, perc_sec_dose, mean_contact
  vacc_comix <- vacc_comix[, c(1,2,3,49)]
  
  combined_data[[dat]] <- vacc_comix 

}
```

## Get c_ij's for each bootstrap data

```{r}
results_list <- list()

for (dat in 1:length(combined_data)) {
  
  vacc_comix <- combined_data[[dat]]
  
  A_p <- matrix(0, length(vacc_comix$date), 4)  

  for (i in 1:length(vacc_comix$date)) {
  
    A_p[i, ] <- c((1 - vacc_comix$perc_first_dose[i]/100)^2,
               (1 - vacc_comix$perc_first_dose[i]/100) * vacc_comix$perc_first_dose[i]/100,
               (1 - vacc_comix$perc_first_dose[i]/100) * vacc_comix$perc_first_dose[i]/100,
              (vacc_comix$perc_first_dose[i]/100)^2)
  
  }

  Ap_transpose <- t(A_p)

  d <- c()

  for (i in 1:length(vacc_comix$date)) {
    d[i] <- vacc_comix$contact[i]
  }


  LHS <- ginv(Ap_transpose %*% A_p)
  RHS <- Ap_transpose %*% d 

  # Estimates for c_ij by using pseudoinverses
  c_ij <- LHS %*% RHS
  
  results_list[[dat]] <- c_ij
  
}
```

Get c_uu, c_vu, and c_vv into separate lists to calculate the median and 95% CI

```{r}
c_uu_list <- list()
c_vu_list <- list()
c_vv_list <- list()

for (dat in 1:length(results_list)) {
  c_uu_list[[dat]] <- results_list[[dat]][1]
  c_vu_list[[dat]] <- results_list[[dat]][2]
  c_vv_list[[dat]] <- results_list[[dat]][4]
  
}

c_uu_df <- do.call(rbind, c_uu_list)
c_vu_df <- do.call(rbind, c_vu_list)
c_vv_df <- do.call(rbind, c_vv_list)
```

Get the mean, median and 95%CI 

```{r}
#c_uu
# Step 1: Order the dataframe
ordered_c_uu <- c_uu_df[order(c_uu_df), ]

# Step 2: Extract the 5th, 100th, and 195th entries
ordered_c_uu[c(5, 100, 195)]

#c_vu
# Step 1: Order the dataframe
ordered_c_vu <- c_vu_df[order(c_vu_df), ]

# Step 2: Extract the 5th, 100th, and 195th entries
ordered_c_vu[c(5, 100, 195)]

#c_vv
# Step 1: Order the dataframe
ordered_c_vv <- c_vv_df[order(c_vv_df), ]

# Step 2: Extract the 5th, 100th, and 195th entries
ordered_c_vv[c(5, 100, 195)]
```

## Get the confidence intervals for the contact data

```{r}
contact_list <- list()

for (dat in 1:length(date_prepared_data)) {
  contact_list[[dat]] <- date_prepared_data[[dat]]$contact
  
}

contact_df <- do.call(rbind, contact_list)

contact_conf <- data.frame(contact = rep(0, 51),
                           lower_ci = rep(0,51),
                           upper_ci = rep(0, 51))

for (i in 1:51) {
  dat_col <- contact_df[,i]
  sorted_dat_col <- dat_col[order(dat_col)]
  vals <- sorted_dat_col[c(5, 100, 195)]
  
  contact_conf$contact[i] <- vals[2]
  contact_conf$lower_ci[i] <- vals[1]
  contact_conf$upper_ci[i] <- vals[3]
  
}

contact_conf <- cbind(date_prepared_data[[1]]$date, contact_conf)
colnames(contact_conf) <- c("date", "contact", "lower_ci", "upper_ci")
```

```{r}
# add contact model into data
no_vacc_contact <- contact_conf %>% filter(date <= "2021-01-31")
vacc_contact <- contact_conf %>% filter(date >= "2021-01-17")
vacc_contact$vacc <- combined_data[[1]]$perc_first_dose
vacc_contact$vacc_tenth <- combined_data[[1]]$perc_first_dose/10

vacc_contact$contact_model <- 1.68 * (1-vacc_contact$vacc/100)^2 + 5.64 * 2 * (1-vacc_contact$vacc/100) * (vacc_contact$vacc/100) + 4.92 * (vacc_contact$vacc/100)^2

vacc_contact$contact_model_lower <- 1.21 * (1-vacc_contact$vacc/100)^2 + 4.70 * 2 * (1-vacc_contact$vacc/100) * (vacc_contact$vacc/100) + 4.43 * (vacc_contact$vacc/100)^2

vacc_contact$contact_model_upper <- 2.10 * (1-vacc_contact$vacc/100)^2 + 6.36 * 2 * (1-vacc_contact$vacc/100) * (vacc_contact$vacc/100) + 5.35 * (vacc_contact$vacc/100)^2
```

# Plot the final result

```{r}
plot_all <- ggplot() +
  geom_line(data = no_vacc_contact, aes(x = date, y = contact, colour = "Data")) +
  geom_ribbon(data = no_vacc_contact, aes(x = date, ymin = lower_ci, ymax = upper_ci), alpha = 0.3, fill = "grey") +
  geom_line(data = vacc_contact, aes(x = date, y = contact, colour = "Data"), linewidth = 1) +
  geom_ribbon(data = vacc_contact, aes(x = date, ymin = lower_ci, ymax = upper_ci), alpha = 0.5, fill = "grey") +
  
  geom_line(data = vacc_contact, aes(x = date, y = contact_model, colour = "Model"), linewidth = 1) +
  geom_ribbon(data = vacc_contact, aes(x = date, ymin = contact_model_lower, ymax = contact_model_upper), alpha = 0.5, fill = "pink") +
  
  geom_line(data = vacc_contact, aes(x = date, y = vacc_tenth, colour = "Vaccination"), linewidth = 1) +
  
  
  scale_y_continuous(name = "Average number of contacts\n(per person)",
                     limits = c(0,10),
                     sec.axis = sec_axis(~. * 10, name = "Vaccinated population (%)")) +
  
  labs(x = "Date", colour = "Colour") +
  
  scale_x_date(breaks = seq(min(no_vacc_contact$date), max(vacc_contact$date), by = "2 month")) +
  
  geom_vline(xintercept = as.Date("2020-03-06"), colour = "black", linetype = "dashed") + 
  geom_vline(xintercept = as.Date("2020-06-01"), colour = "black", linetype = "dashed") +
  geom_vline(xintercept = as.Date("2020-11-05"), colour = "black", linetype = "dotted") + 
  geom_vline(xintercept = as.Date("2020-12-02"), colour = "black", linetype = "dotted") +
  geom_vline(xintercept = as.Date("2021-01-06"), colour = "black", linetype = "dashed") + 
  geom_vline(xintercept = as.Date("2021-03-07"), colour = "black", linetype = "dashed") +
  
  scale_colour_manual(values = c("Data" = "black",
                                 "Vaccination" = "blue",
                                 "Model" = "red")) +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12)
  ) +
  theme(plot.background = element_rect(fill = "white", colour = NA))
  

```

```{r}
ggsave("/Users/df23614/Desktop/vaccine_model/Figure_formatted/Fig_2.tiff", plot_all, dpi = 300, width = 7.48, height = 5.5, units = "in", device = "tiff", compression = "lzw")
```